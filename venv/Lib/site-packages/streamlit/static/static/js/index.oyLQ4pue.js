import{r as s,E as G,_ as P,g as Q,e as I,N as K,M as Y,bj as L,bk as M,bl as Z,bm as q,n as H,bn as j,Q as U,R as ee,f as te,b3 as ne,bo as re,j as A,l as se,aG as oe}from"./index.CqTPbV5Y.js";import{w as ae,E as ie}from"./withFullScreenWrapper.7j_lzlaF.js";import{a as k,S as _,T as ce}from"./Toolbar.DMgU0Vgw.js";import{R as le}from"./index.Buc7XrOl.js";import{a as J,c as ue,b as fe,e as de,t as me,S as he,d as pe}from"./embed.HKcgTiLB.js";import{u as ge}from"./FormClearHelper.-9RbsnV0.js";import"./moment.C3j7ZXd7.js";import"./pandasStylerUtils.DqP0h70z.js";import"./_baseIndexOf.BTknn6Gb.js";import"./sprintf.D7DtBTRn.js";import"./index.8HslT92O.js";import"./main.eVHOp4Th.js";import"./throttle.D3b5WILl.js";import"./checkbox.5xWaqPqm.js";import"./createDownloadLinkElement.ZaXNnPK4.js";import"./toConsumableArray.DIN_ys1J.js";import"./possibleConstructorReturn.C_51n46K.js";import"./createSuper.OIgV8wc-.js";import"./FileDownload.esm.CV-WYqBn.js";import"./_arrayIncludes.B19Iyn2B.js";import"./threshold.Q1mXg5rX.js";import"./value.B4vHRSi7.js";import"./timer.C2hYhUse.js";var B=s.forwardRef(function(n,t){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return s.createElement(G,P({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),s.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),s.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});B.displayName="InsertChart";var $=s.forwardRef(function(n,t){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return s.createElement(G,P({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),s.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),s.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});$.displayName="TableChart";const Se=20;function ye(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&I(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const be=(n,t,o,r,u,c,l,h)=>{const e=JSON.parse(n);if(r==="streamlit"?e.config=J(e.config,c):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=J(e.config,c),e.usermeta.embedOptions.theme=void 0):e.config=ue(e.config,c),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(l-40,0)),o&&(e.height=h),t&&(e.width=l,"vconcat"in e&&e.vconcat.forEach(f=>{f.width=l})),e.padding||(e.padding={}),I(e.padding.bottom)&&(e.padding.bottom=Se),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return u.length>0&&ye(e),e},we=(n,t,o,r,u)=>{const c=Q(),{id:l,formId:h,spec:e,data:f,datasets:a,vegaLiteTheme:d,selectionMode:i}=n,p=s.useMemo(()=>i,[JSON.stringify(i)]),S=s.useMemo(()=>be(e,r,u,d,p,c,t,o),[e,r,u,d,p,c,t,o]);return{id:l,formId:h,vegaLiteTheme:d,spec:S,selectionMode:p,data:f,datasets:a,useContainerWidth:r}},Ce={DATAFRAME_INDEX:"(index)"};function Ee(n){return!n||n.dimensions.numDataRows===0?null:z(n)}function Ve(n){const t=F(n);if(I(t))return null;const o={};for(const[r,u]of Object.entries(t))o[r]=z(u);return o}function F(n){if(n?.length===0)return null;const t={};return n.forEach(o=>{if(!o)return;const r=o.hasName?o.name:null;t[r]=o.data}),t}function z(n,t=0){if(n.dimensions.numDataRows===0)return[];const o=[],{numDataRows:r,numDataColumns:u,numIndexColumns:c}=n.dimensions,l=n.columnTypes[0]??void 0,h=l&&l.type===K.INDEX&&(Y(l)||L(l)||M(l));for(let e=t;e<r;e++){const f={};if(h){const{content:a}=n.getCell(e,0);f[Ce.DATAFRAME_INDEX]=typeof a=="bigint"?Number(a):a}for(let a=0;a<u;a++){const d=a+c,{content:i,contentType:p}=n.getCell(e,d);if((i instanceof Date||typeof i=="number"&&Number.isFinite(i))&&(L(p)||M(p))&&!Z(p)){const S=new Date(i).getTimezoneOffset()*60*1e3;f[n.columnNames[0][d]]=i.valueOf()+S}else f[n.columnNames[0][d]]=typeof i=="bigint"?Number(i):i}o.push(f)}return o}const ve=150,De=U.getLogger("useVegaLiteSelections"),Ne=(n,t,o)=>{const{id:r,formId:u,selectionMode:c}=n,l=s.useCallback(e=>{c.forEach(a=>{e.addSignalListener(a,q(ve,(d,i)=>{const p=e.getState({data:(C,O)=>c.some(g=>`${g}_store`===C),recurse:!1});H(p)&&t.setElementState(r,"viewState",p);let S=i;"vlPoint"in i&&"or"in i.vlPoint&&(S=i.vlPoint.or);const D={id:r,formId:u},V=JSON.parse(t.getStringValue(D)||"{}"),v={selection:{...V?.selection||{},[d]:S||{}}};j(V,v)||t.setStringValue(D,JSON.stringify(v),{fromUi:!0},o)}))});const f=t.getElementState(r,"viewState");if(H(f))try{return e.setState(f)}catch(a){De.warn("Failed to restore view state",a)}return e},[r,c,t,u,o]),h=s.useCallback(()=>{const e={selection:{}};c.forEach(i=>{e.selection[i]={}});const f={id:r,formId:u},a=t.getStringValue(f),d=a?JSON.parse(a):e;j(d,e)||t.setStringValue(f,JSON.stringify(e),{fromUi:!0},o)},[r,u,o,c,t]);return{maybeConfigureSelections:l,onFormCleared:h}},W="source",Te=U.getLogger("useVegaEmbed");function Oe(n,t,o){const r=s.useRef(null),u=s.useRef(null),c=s.useRef(W),l=s.useRef(null),h=s.useRef([]),e=s.useRef(null),f=s.useRef([]),[a,d]=s.useState(!1),{maybeConfigureSelections:i,onFormCleared:p}=Ne(n,t,o);ge({widgetMgr:t,element:n,onFormCleared:p});const{data:S,datasets:D}=n;s.useEffect(()=>{e.current=S,f.current=D,r.current===null&&(l.current=S,h.current=D)},[S,D]);const V=s.useCallback(()=>{u.current&&u.current(),u.current=null,r.current=null},[]),v=s.useCallback(async(g,y)=>{if(g.current===null)throw new Error("Element missing.");d(!0);try{V();const b={ast:!0,expr:fe,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:w,view:T,finalize:E}=await de(g.current,y,b);r.current=i(T),u.current=E;const m=Ve(f.current),N=m?Object.keys(m):[];if(N.length===1){const[x]=N;c.current=x}else N.length===0&&w.data&&(c.current=W);const R=Ee(e.current);if(R&&r.current.insert(c.current,R),m)for(const[x,X]of Object.entries(m))r.current.insert(x,X);return await r.current.runAsync(),await r.current.resize().runAsync(),l.current=e.current,h.current=f.current,r.current}finally{d(!1)}},[V,i]),C=s.useCallback((g,y,b,w)=>{if(!w||w.dimensions.numDataRows===0){try{g.remove(y,me)}catch{}return}if(!b||b.dimensions.numDataRows===0){g.insert(y,z(w));return}w.hash!==b.hash&&(g.data(y,z(w)),Te.info(`Had to clear the ${y} dataset before inserting data through Vega view.`))},[]),O=s.useCallback(async(g,y)=>{if(r.current===null||a)return null;const b=l.current,w=h.current;(b||g)&&C(r.current,c.current,b,g);const T=F(w)??{},E=F(y)??{};for(const[m,N]of Object.entries(E)){const R=m||c.current,x=T[R];C(r.current,R,x,N)}for(const m of Object.keys(T))!Object.hasOwn(E,m)&&m!==c.current&&C(r.current,m,null,null);return await r.current?.resize().runAsync(),l.current=g,h.current=y,r.current},[C,a]);return{createView:v,updateView:O,finalizeView:V}}function Ae(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const Re=({disableFullscreenMode:n,element:t,fragmentId:o,widgetMgr:r,widthConfig:u,heightConfig:c})=>{const[l,h]=s.useState(!1),[e,f]=s.useState(!1),{expanded:a,height:d,width:i,expand:p,collapse:S}=ee(ie),{width:D,height:V,elementRef:v}=te([l],0),C=ne(u)||t.useContainerWidth,O=re(c),g=Ae(t.spec),y=we(t,g?i??0:D,(a?d:V)??0,a?!0:C,a?!0:O),{createView:b,updateView:w,finalizeView:T}=Oe(y,r,o),{data:E,datasets:m,spec:N}=y;return s.useLayoutEffect(()=>(v.current!==null&&b(v,N),T),[b,T,N,i,d,l,v]),s.useEffect(()=>{w(E,m)},[E,m]),s.useEffect(()=>{E||m?.[0]?.data?f(!0):f(!1)},[E,m]),l?A(le,{data:E??m[0]?.data,height:d??V??void 0,width:u??void 0,customToolbarActions:[A(k,{label:"Show chart",icon:B,onClick:()=>{h(!1)}},"show-chart")]}):se(_,{height:O?a?d:"100%":d,useContainerWidth:a?!0:C,children:[A(ce,{target:_,isFullScreen:a,onExpand:p,onCollapse:S,disableFullscreenMode:n,children:e&&A(k,{label:"Show data",icon:$,onClick:()=>{h(!0)}})}),A(oe,{styles:[he]}),A(pe,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:C,useContainerHeight:O,ref:v})]})},xe=ae(Re),tt=s.memo(xe);export{he as StyledVegaLiteChartTooltips,J as applyStreamlitTheme,tt as default};
